---
title: Tri·ªÉn khai ch·ª©c nƒÉng Ban t√†i kho·∫£n trong Laravel
description: >-
  Trong b·∫•t k·ª≥ ·ª©ng d·ª•ng n√†o, d√π l√† web app hay mobile app, vi·ªác x·ª≠ l√Ω nh·ªØng user
  "qu√° kh√≠ch" ho·∫∑c kh√¥ng tu√¢n th·ªß "Terms" l√† ƒëi·ªÅu kh√¥ng th·ªÉ tr√°nh kh·ªèi. Khi ƒë√≥,
  ch·ª©c nƒÉng ban account tr·ªü th√†nh ‚Äúv≈© kh√≠‚Äù c·∫ßn thi·∫øt gi√∫p b·∫°n ki·ªÉm so√°t v√† duy
  tr√¨ s·ª± l√†nh m·∫°nh trong h·ªá th·ªëng.
author: content/authors/nguyen-gia-hao.md
category: []
excerpt: >
  Trong b·∫•t k·ª≥ ·ª©ng d·ª•ng n√†o, d√π l√† web app hay mobile app, vi·ªác x·ª≠ l√Ω nh·ªØng user
  "qu√° kh√≠ch" ho·∫∑c kh√¥ng tu√¢n th·ªß "Terms" l√† ƒëi·ªÅu kh√¥ng th·ªÉ tr√°nh kh·ªèi. Khi ƒë√≥,
  ch·ª©c nƒÉng ban account tr·ªü th√†nh ‚Äúv≈© kh√≠‚Äù c·∫ßn thi·∫øt gi√∫p b·∫°n ki·ªÉm so√°t v√† duy
  tr√¨ s·ª± l√†nh m·∫°nh trong h·ªá th·ªëng.


  Kh√¥ng ƒë∆°n gi·∫£n ch·ªâ l√† kh√≥a t√†i kho·∫£n, h·ªá th·ªëng ban c·∫ßn ph·∫£i linh ho·∫°t, cho
  ph√©p ban t·∫°m th·ªùi hay permanent, l∆∞u l·∫°i reason, th√¥ng tin v·ªÅ ai ƒë√£ ban, v√†
  khi n√†o ban h·∫øt hi·ªáu l·ª±c.
---

üîß 1. T·∫°o b·∫£ng bans

Schema::create('bans', function (Blueprint $table) {

$table->increments('id');

$table->morphs('bannable'); // B·∫•t k·ª≥ ƒë·ªëi t∆∞·ª£ng n√†o c√≥ th·ªÉ b·ªã ban

$table->nullableMorphs('created\_by'); // Ai ƒë√£ ban (Admin, Moderator,...)

$table->string('reason\_code')->nullable(); // M√£ l√Ω do ban (VD: spam, abuse, other,...)

$table->text('comment')->nullable(); // Ghi ch√∫ chi ti·∫øt n·∫øu c·∫ßn

$table->timestamp('expired\_at')->nullable(); // N·∫øu null = ban vƒ©nh vi·ªÖn

$table->softDeletes(); // G·ª° ban = soft delete

$table->timestamps();

$table->index('expired\_at');

$table->index('reason\_code');

});

üìå L∆∞u √Ω: Morph cho ph√©p b·∫°n t√°i s·ª≠ d·ª•ng b·∫£ng bans cho nhi·ªÅu lo·∫°i model, r·∫•t ti·ªán v√† ‚ÄúDRY‚Äù (Don't Repeat Yourself).

üì¶ Model Ban

class Ban extends Model

{

use SoftDeletes;

protected $fillable = \[

'reason\_code',

'comment',

'expired\_at',

];

protected $dates = \['expired\_at'];

public function bannable()

{

return $this->morphTo();

}

public function createdBy()

{

return $this->morphTo('created\_by');

}

public function isActive(): bool

{

return is\_null($this->expired\_at) || now()->lessThan($this->expired\_at);

}

}




üë§ 2. K·∫øt n·ªëi v·ªõi model User (ho·∫∑c b·∫•t k·ª≥ model n√†o b·∫°n mu·ªën ban)

class User extends Authenticatable

{

public function bans()

{

return $this->morphMany(Ban::class, 'bannable');

}

public function activeBan()

{

return $this->bans()

->whereNull('deleted\_at')

->where(function ($query) {

$query->whereNull('expired\_at')->orWhere('expired\_at', '>', now());

})

->latest('created\_at')

->first();

}

public function isBanned(): bool

{

return !is\_null($this->activeBan());

}

}







üö™ 3. Middleware ch·∫∑n ng∆∞·ªùi b·ªã ban

NgƒÉn ng∆∞·ªùi d√πng b·ªã ban truy c·∫≠p v√†o h·ªá th·ªëng nh∆∞ sau:

public function handle($request, Closure $next) { $user = auth()->user(); if ($user && $user->isBanned()) { abort(403, 'T√†i kho·∫£n c·ªßa b·∫°n ƒë√£ b·ªã kh√≥a.'); } return $next($request); }

üßë‚Äç‚öñÔ∏è 4. Ban v√† g·ª° ban trong Controller

public function banUser(User $user, Request $request) { $user->bans()->create(\[ 'reason\_code' => $request->input('reason\_code'), 'comment' => $request->input('comment'), 'expired\_at' => $request->input('expired\_at'), 'created\_by\_type' => auth()->check() ? get\_class(auth()->user()) : null, 'created\_by\_id' => auth()->id(), ]); return response()->json(\['message' => 'Ng∆∞·ªùi d√πng ƒë√£ b·ªã ban.']); } public function unbanUser(User $user) { $user->bans() ->whereNull('deleted\_at') ->latest() ->first()?->delete(); return response()->json(\['message' => 'Ng∆∞·ªùi d√πng ƒë√£ ƒë∆∞·ª£c g·ª° ban.']); }

üí° B·∫°n c√≥ th·ªÉ tu·ª≥ ch·ªânh logic sao cho m·ªôt user ch·ªâ c√≥ m·ªôt ban ƒëang ho·∫°t ƒë·ªông c√πng l√∫c, n·∫øu c·∫ßn.

üïµÔ∏è‚Äç‚ôÇÔ∏è 5. L·ªçc theo l√Ω do b·ªã ban

$spamBans = Ban::where('reason\_code', 'spam')->with('bannable')->get();

Ho·∫∑c l·ªçc t·∫•t c·∫£ ng∆∞·ªùi d√πng ƒëang b·ªã ban v√¨ ‚Äúabuse‚Äù:

$users = User::whereHas('bans', function ($query) { $query->where('reason\_code', 'abuse') ->where(function ($q) { $q->whereNull('expired\_at')->orWhere('expired\_at', '>', now()); }) ->whereNull('deleted\_at'); })->get();

‚è∞ 6. T·ª± ƒë·ªông g·ª° ban (t√πy ch·ªçn)

Thay v√¨ ph·∫£i g·ª° th·ªß c√¥ng, b·∫°n c√≥ th·ªÉ ch·∫°y m·ªôt scheduled job xo√° c√°c ban ƒë√£ h·∫øt h·∫°n:

User::whereHas('bans', function ($query) { $query->whereNotNull('expired\_at') ->where('expired\_at', '\<=', now()) ->whereNull('deleted\_at'); })->each(function ($user) { $user->bans() ->where('expired\_at', '\<=', now()) ->whereNull('deleted\_at') ->delete(); });

ƒê∆∞a v√†o Kernel.php ch·∫°y m·ªói gi·ªù, ho·∫∑c m·ªói ng√†y t√πy b·∫°n.
